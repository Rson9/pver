name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.0.2)'
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.setvars.outputs.version }}
      short_version: ${{ steps.setvars.outputs.short_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Set version variables
        id: setvars
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SHORT_VER="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_version=${SHORT_VER}" >> $GITHUB_OUTPUT

      - name: Tag version
        run: |
          TAG="${{ steps.setvars.outputs.version }}"
          
          # 检查标签是否已存在
          if git tag -l | grep -q "$TAG"; then
            echo "Tag $TAG already exists. Deleting local tag..."
            git tag -d "$TAG"
            git push origin --delete "$TAG" || echo "Remote tag deletion failed, continuing..."
          fi
          
          # 创建并推送新标签
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
